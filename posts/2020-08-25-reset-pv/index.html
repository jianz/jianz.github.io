<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.74.3" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>How to reset persistent volume status from terminating back to bound.&nbsp;&ndash;&nbsp;Things to share</title><link rel="stylesheet" href="/css/core.min.4bd95be1862ee3ff37c23cc27555a05fa1a802cf208b5c6ed3968638ac36cbdfcd7f1ff1c422f3b6e14e364fc0b4b0ae.css" integrity="sha384-S9lb4YYu4/83wjzCdVWgX6GoAs8gi1xu05aGOKw2y9/Nfx/xxCLztuFONk/AtLCu"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="How to reset persistent volume status from terminating back to bound." /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">Things to share</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">Categories</a><a class="nav item" href="/tags/">Tags</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">How to reset persistent volume status from terminating back to bound.</h1><p class="article date">Aug 25, 2020<span class="reading-time"> â€¢ 11 minutes to read</span></p></section><article class="article markdown-body"><h2 id="tldr">TL;DR</h2>
<p>If you deleted a kubernetes persistent volume by accident, and it stuck in the terminating status due to <code>kubernetes.io/pv-protection</code> finalizer prevent it from being deleted. You can use this <a href="https://github.com/jianz/k8s-reset-terminating-pv"target="_blank">k8s-reset-terminating-pv</a> tool to reset its status back to bound.</p>
<h2 id="prologue">Prologue</h2>
<p>You may notice this is the first post of my blog.ðŸ¥³ Actually, I wanted to write a blog a very very long time ago but did not find anything worth sharing until one day I deleted a very important persistent volume by accident.ðŸ˜± The PV is used by the docker image repository that holds hundreds of images used by several kubernetes clusters and the <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#reclaiming"target="_blank">reclaim policy</a> of the PV is Delete. I can still recall vividly the moment I realized what I just did, but after a while, the PV is still in the Terminating status, my first thought was the size of the PV is so big that it takes times to delete it, then I realized it is the <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#storage-object-in-use-protection"target="_blank">finalizer</a> that protect the PV from being deleted. Thank God the kubernetes has such a beautiful design that gives careless people like me a second chance.ðŸ˜‚</p>
<p>As I said earlier, the PV is now stuck in the Terminating status,</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS        CLAIM         STORAGECLASS          REASON   AGE
pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89   1Gi        RWO            Delete           Terminating   image/repo    managed-nfs-storage            29h
</code></pre></div><p>and I want to set it back to Bound status. I thought that should be a piece of cake, I just need to set the status of the PV to Bound in its YAML definition, right? No, that is not <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#finalizers"target="_blank">how finalizer works</a>. Even though the PV appears in Terminating status, its actual status is still Bound, the finalizer relies on <code>deletionTimestamp</code> and <code>deletionGracePeriodSeconds</code> fields inside metadata to fulfill its purpose.</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">kind</span><span class="p">:</span><span class="w"> </span>PersistentVolume<span class="w">
</span><span class="w"></span><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">pv.kubernetes.io/provisioned-by</span><span class="p">:</span><span class="w"> </span>storage.io/nfs<span class="w">
</span><span class="w">  </span><span class="k">selfLink</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;/api/v1/persistentvolumes/pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89&#39;</span><span class="w">
</span><span class="w">  </span><span class="k">deletionTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2020-08-23T09:38:42Z&#39;</span><span class="w">
</span><span class="w">  </span><span class="k">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;112535964&#39;</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89&#39;</span><span class="w">
</span><span class="w">  </span><span class="k">uid</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;d77ec8f7-710f-4005-b119-b7c1cda8d7e7&#39;</span><span class="w">
</span><span class="w">  </span><span class="k">deletionGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="w">  </span><span class="k">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2020-08-22T03:39:41Z&#39;</span><span class="w">
</span><span class="w">  </span><span class="k">finalizers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- kubernetes.io/pv-protection<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">capacity</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">storage</span><span class="p">:</span><span class="w"> </span>1Gi<span class="w">
</span><span class="w">  </span><span class="k">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- ReadWriteOnce<span class="w">
</span><span class="w">  </span><span class="k">claimRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>PersistentVolumeClaim<span class="w">
</span><span class="w">    </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>image<span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>repo<span class="w">
</span><span class="w">    </span><span class="k">uid</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;eef4ec4b-326d-47e6-b11c-6474a5fd4d89&#39;</span><span class="w">
</span><span class="w">    </span><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w">    </span><span class="k">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;111102610&#39;</span><span class="w">
</span><span class="w">  </span><span class="k">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span>Delete<span class="w">
</span><span class="w">  </span><span class="k">storageClassName</span><span class="p">:</span><span class="w"> </span>managed-nfs-storage<span class="w">
</span><span class="w">  </span><span class="k">volumeMode</span><span class="p">:</span><span class="w"> </span>Filesystem<span class="w">
</span><span class="w"></span><span class="k">status</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">phase</span><span class="p">:</span><span class="w"> </span>Bound<span class="w">
</span></code></pre></div><p>In <a href="https://github.com/kubernetes/apimachinery/blob/release-1.19/pkg/apis/meta/v1/types.go#L198-L224"target="_blank">types.go</a> source code, it clearly point out that:</p>
<blockquote>
<p>Once the deletionTimestamp is set, this value may not be unset or be set further into the future, although it may be shortened or the resource may be deleted prior to this time.</p>
</blockquote>
<p>Which means I cannot set the status back to Bound in a normal(kubernetes supported) way. Kubernetes uses etcd as its data store, so I guess I can delete the value of <code>deletionTimestamp</code> and <code>deletionGracePeriodSeconds</code> in etcd to forcedly reset the PV status back to Bound, and <a href="https://stackoverflow.com/a/54189534"target="_blank">this answer</a> supported my point of view.</p>
<h2 id="the-journey-of-etcd">The journey of etcd</h2>
<p>Since I cannot reset PV status back to Bound using the kubectl client or calling the kubernetes API, I decided to update the PV&rsquo;s value in etcd directly. There is <a href="https://medium.com/better-programming/a-closer-look-at-etcd-the-brain-of-a-kubernetes-cluster-788c8ea759a5"target="_blank">a great post</a> about how kubernetes uses etcd. Please read this article before continuing.</p>
<p>First, I need to connect to etcd to get the value of the PV in terminating status. I use <a href="https://github.com/etcd-io/etcd/tree/master/clientv3"target="_blank">etcd Go client</a> as it is used by kubernetes to interact with etcd. It uses PKI certificates to establish a security connection, you can get the required etcd CA(ca.crt), Public(etcd.crt) and Private(etcd.key) certificates from the kubernetes etcd Node/Pod that explained on <a href="https://medium.com/better-programming/a-closer-look-at-etcd-the-brain-of-a-kubernetes-cluster-788c8ea759a5"target="_blank">above</a> post.</p>
<p>The code to create an etcd client:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">etcdClient</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ca</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">etcdCA</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="nx">keyPair</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tls</span><span class="p">.</span><span class="nf">LoadX509KeyPair</span><span class="p">(</span><span class="nx">etcdCert</span><span class="p">,</span> <span class="nx">etcdKey</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="nx">certPool</span> <span class="o">:=</span> <span class="nx">x509</span><span class="p">.</span><span class="nf">NewCertPool</span><span class="p">()</span>
  <span class="nx">certPool</span><span class="p">.</span><span class="nf">AppendCertsFromPEM</span><span class="p">(</span><span class="nx">ca</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
    <span class="nx">Endpoints</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s:%d&#34;</span><span class="p">,</span> <span class="nx">etcdHost</span><span class="p">,</span> <span class="nx">etcdPort</span><span class="p">)},</span> <span class="c1">//localhost:2379
</span><span class="c1"></span>    <span class="nx">DialTimeout</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
    <span class="nx">TLS</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
      <span class="nx">RootCAs</span><span class="p">:</span>      <span class="nx">certPool</span><span class="p">,</span>
      <span class="nx">Certificates</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">{</span><span class="nx">keyPair</span><span class="p">},</span>
    <span class="p">},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div><p>Then get the value of the PV:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">key</span> <span class="o">:=</span> <span class="s">&#34;/registry/persistentvolumes/pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89&#34;</span>
<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Kvs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Value</span><span class="p">))</span>
</code></pre></div><p>I forward the etcd port on the pod to the localhost, then my client can use localhost:2379 to connect to the etcd server.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">kubectl port-forward pods/etcd-member-master0 2379:2379 -n kube-system
</code></pre></div><p>The output of the code shows the <code>raw</code> value of PV in etcd:</p>
<pre><code class="language-raw" data-lang="raw">k8s

v1PersistentVolumeï¿½
ï¿½
(pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89&quot;*$d77ec8f7-710f-4005-b119-b7c1cda8d7e72ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½PZ

appimageb1
pv.kubernetes.io/provisioned-bystorage.io/nfsrubernetes.io/pv-protectionzï¿½

storage
1GiS*Q

ReadWriteOnce&quot;\ata/nfs1/image-repo-pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89
PersistentVolumeClaimimagerepo&quot;$eef4ec4b-326d-47e6-b11c-6474a5fd4d89*v12       111102610:*Delete2managed-nfs-storageB
Filesystem

Bound&quot;
</code></pre><p>Even though most of the content is readable by a human, there are several mysterious characters &lsquo;ï¿½&rsquo; scattered around the output. I can see the PV&rsquo;s Version, Kind, and UID, its label, size, and some attributes, but where are the <code>deletionTimestamp</code> and <code>deletionGracePeriodSeconds</code>?</p>
<p>After some digging, I understand that kubernetes has two serialization format, the JSON and the Protobuf. You can verify this by looking at <a href="https://github.com/kubernetes/apimachinery/blob/release-1.19/pkg/apis/meta/v1/types.go"target="_blank">type.go</a>, each struct field that needs to be serialized has json and protobuf definition in its tag like <code>`json:&quot;kind,omitempty&quot; protobuf:&quot;bytes,1,opt,name=kind&quot;`</code> . The JSON is the default serialization format for the API, so when we use kubectl to get the resources we get them in JSON format.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get pod --v<span class="o">=</span><span class="m">9</span>

I0824 10:43:27.478474   <span class="m">30383</span> round_trippers.go:423<span class="o">]</span> curl -k -v -XGET  -H <span class="s2">&#34;Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json&#34;</span> -H <span class="s2">&#34;User-Agent: kubectl/v1.18.8 (darwin/amd64) kubernetes/9f2892a&#34;</span> <span class="s1">&#39;https://10.61.2.249:6443/api/v1/namespaces/default/pods?limit=500&#39;</span>
I0824 10:43:27.494898   <span class="m">30383</span> round_trippers.go:443<span class="o">]</span> GET https://10.61.2.249:6443/api/v1/namespaces/default/pods?limit<span class="o">=</span><span class="m">500</span> <span class="m">200</span> OK in <span class="m">16</span> milliseconds
I0824 10:43:27.494937   <span class="m">30383</span> round_trippers.go:449<span class="o">]</span> Response Headers:
I0824 10:43:27.494955   <span class="m">30383</span> round_trippers.go:452<span class="o">]</span>     Cache-Control: no-cache, private
I0824 10:43:27.494961   <span class="m">30383</span> round_trippers.go:452<span class="o">]</span>     Content-Type: application/json
I0824 10:43:27.494966   <span class="m">30383</span> round_trippers.go:452<span class="o">]</span>     Date: Mon, <span class="m">24</span> Aug <span class="m">2020</span> 02:43:27 GMT
I0824 10:43:27.496179   <span class="m">30383</span> request.go:1068<span class="o">]</span> Response Body: <span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;Table&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;meta.k8s.io/v1&#34;</span>,<span class="s2">&#34;metadata&#34;</span>:<span class="o">{</span><span class="s2">&#34;selfLink&#34;</span>:<span class="s2">&#34;/api/v1/namespaces/default/pods&#34;</span>,<span class="s2">&#34;resourceVersion&#34;</span>:<span class="s2">&#34;812855&#34;</span><span class="o">}</span>,<span class="s2">&#34;columnDefinitions&#34;</span>:<span class="o">[{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Name&#34;</span>,<span class="s2">&#34;type&#34;</span>:<span class="s2">&#34;string&#34;</span>,<span class="s2">&#34;format&#34;</span>:<span class="s2">&#34;name&#34;</span>,<span class="s2">&#34;description&#34;</span>:<span class="s2">&#34;Name must be unique within a namespace. Is required when creating resources, although some resources may allow a client to request the generation of an appropriate name automatically. Name is primarily intended for creation idempotence and configuration definition. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/identifiers#names&#34;</span>,<span class="s2">&#34;priority&#34;</span>:0<span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Ready&#34;</span>,<span class="s2">&#34;type&#34;</span>:<span class="s2">&#34;string&#34;</span>,<span class="s2">&#34;format&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;description&#34;</span>:<span class="s2">&#34;The aggregate readiness state of this pod for accepting traffic.&#34;</span>,<span class="s2">&#34;priority&#34;</span>:0<span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Status&#34;</span>,<span class="s2">&#34;type&#34;</span>:<span class="s2">&#34;string&#34;</span>,<span class="s2">&#34;format&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;description&#34;</span>:<span class="s2">&#34;The aggregate status of the containers in this pod.&#34;</span>,<span class="s2">&#34;priority&#34;</span>:0<span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Restarts&#34;</span>,<span class="s2">&#34;type&#34;</span>:<span class="s2">&#34;integer&#34;</span>,<span class="s2">&#34;format&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;description&#34;</span>:<span class="s2">&#34;The number of times the containers in this pod have been restarted.&#34;</span>,<span class="s2">&#34;priority&#34;</span>:0<span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Age&#34;</span>,<span class="s2">&#34;type&#34;</span>:<span class="s2">&#34;string&#34;</span>,<span class="s2">&#34;format&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;description&#34;</span>:<span class="s2">&#34;CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC.\n\nPopulated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata&#34;</span>,<span class="s2">&#34;priority&#34;</span>:0<span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;IP&#34;</span>,<span class="s2">&#34;type&#34;</span>:<span class="s2">&#34;string&#34;</span>,<span class="s2">&#34;format&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;description&#34;</span>:<span class="s2">&#34;IP address allocated to the pod. Routable at least within the cluster. Empty if not yet allocated.&#34;</span>,<span class="s2">&#34;priority&#34;</span>:1<span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Node&#34;</span>,<span class="s2">&#34;type&#34;</span>:<span class="s2">&#34;string&#34;</span>,<span class="s2">&#34;format&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;description&#34;</span>:<span class="s2">&#34;NodeName is a request to schedule this pod onto a specific node. If it is non-empty, the scheduler simply schedules this pod onto that node, assuming that it fits resource requirements.&#34;</span>,<span class="s2">&#34;priority&#34;</span>:1<span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Nominated Node&#34;</span>,<span class="s2">&#34;type&#34;</span>:<span class="s2">&#34;string&#34;</span>,<span class="s2">&#34;format&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;description&#34;</span>:<span class="s2">&#34;nominatedNodeName is set only when this pod preempts other pods on the node, but it cannot be scheduled right away as preemption victims receive their graceful termination periods. This field does not guarantee that the pod will be scheduled on this node. Scheduler may decide to place the pod elsewhere if other nodes become available sooner. Scheduler may also decide to give the resources on this node to a higher priority pod that is created after preemption. As a result, this field may be different than PodSpec.nodeName when the pod is scheduled.&#34;</span>,<span class="s2">&#34;priority&#34;</span>:1<span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Readiness Gates&#34;</span>,<span class="s2">&#34;type&#34;</span>:<span class="s2">&#34;string&#34;</span>,<span class="s2">&#34;format&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;description&#34;</span>:<span class="s2">&#34;If specified, all readiness gates will be evaluated for pod readiness. A pod is ready when all its containers are ready AND all conditions specified in the readiness gates have status equal to \&#34;True\&#34; More info: https://git.k8s.io/enhancements/keps/sig-network/0007-pod-ready%2B%2B.md&#34;</span>,<span class="s2">&#34;priority&#34;</span>:1<span class="o">}]</span>,<span class="s2">&#34;rows&#34;</span>:<span class="o">[{</span><span class="s2">&#34;cells&#34;</span>:<span class="o">[</span><span class="s2">&#34;busybox&#34;</span>,<span class="s2">&#34;1/1&#34;</span>,<span class="s2">&#34;Running&#34;</span>,72,<span class="s2">&#34;3d&#34;</span>,<span class="s2">&#34;10.200.1.5&#34;</span>,<span class="s2">&#34;k8s5&#34;</span>,<span class="s2">&#34;\u003cnone\u003e&#34;</span>,<span class="s2">&#34;\u003cnone\u003e&#34;</span><span class="o">]</span>,<span class="s2">&#34;object&#34;</span>:<span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;PartialObjectMetadata&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;meta.k8s.io/v1&#34;</span>,<span class="s2">&#34;metadata&#34;</span>:<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;busybox&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;default&#34;</span>,<span class="s2">&#34;selfLink&#34;</span>:<span class="s2">&#34;/api/v1/namespaces/default/pods/busybox&#34;</span>,<span class="s2">&#34;uid&#34;</span>:<span class="s2">&#34;8f208315-c20c-45b8-900b-57d7c13678e4&#34;</span>,<span class="s2">&#34;resourceVersion&#34;</span>:<span class="s2">&#34;811714&#34;</span>,<span class="s2">&#34;creationTimestamp&#34;</span>:<span class="s2">&#34;2020-08-21T02:34:42Z&#34;</span>,<span class="s2">&#34;labels&#34;</span>:<span class="o">{</span><span class="s2">&#34;run&#34;</span>:<span class="s2">&#34;busybox&#34;</span><span class="o">}</span>,<span class="s2">&#34;managedFields&#34;</span>:<span class="o">[{</span><span class="s2">&#34;manager&#34;</span>:<span class="s2">&#34;kubectl&#34;</span>,<span class="s2">&#34;operation&#34;</span>:<span class="s2">&#34;Update&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;v1&#34;</span>,<span class="s2">&#34;time&#34;</span>:<span class="s2">&#34;2020-08-21T02:34:42Z&#34;</span>,<span class="s2">&#34;fieldsType&#34;</span>:<span class="s2">&#34;FieldsV1&#34;</span>,<span class="s2">&#34;fieldsV1&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:metadata&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:labels&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:run&#34;</span>:<span class="o">{}}}</span>,<span class="s2">&#34;f:spec&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:containers&#34;</span>:<span class="o">{</span><span class="s2">&#34;k:{\&#34;name\&#34;:\&#34;busybox\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:command&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:image&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:imagePullPolicy&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:name&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:resources&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:terminationMessagePath&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:terminationMessagePolicy&#34;</span>:<span class="o">{}}}</span>,<span class="s2">&#34;f:dnsPolicy&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:enableServiceLinks&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:restartPolicy&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:schedulerName&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:securityContext&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:terminationGracePeriodSeconds&#34;</span>:<span class="o">{}}}}</span>,<span class="o">{</span><span class="s2">&#34;manager&#34;</span>:<span class="s2">&#34;kubelet&#34;</span>,<span class="s2">&#34;operation&#34;</span>:<span class="s2">&#34;Update&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;v1&#34;</span>,<span class="s2">&#34;time&#34;</span>:<span class="s2">&#34;2020-08-24T02:35:46Z&#34;</span>,<span class="s2">&#34;fieldsType&#34;</span>:<span class="s2">&#34;FieldsV1&#34;</span>,<span class="s2">&#34;fieldsV1&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:status&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:conditions&#34;</span>:<span class="o">{</span><span class="s2">&#34;k:{\&#34;type\&#34;:\&#34;ContainersReady\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastProbeTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastTransitionTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:status&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:type&#34;</span>:<span class="o">{}}</span>,<span class="s2">&#34;k:{\&#34;type\&#34;:\&#34;Initialized\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastProbeTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastTransitionTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:status&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:type&#34;</span>:<span class="o">{}}</span>,<span class="s2">&#34;k:{\&#34;type\&#34;:\&#34;Ready\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastProbeTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastTransitionTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:status&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:type&#34;</span>:<span class="o">{}}}</span>,<span class="s2">&#34;f:containerStatuses&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:hostIP&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:phase&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:podIP&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:podIPs&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;k:{\&#34;ip\&#34;:\&#34;10.200.1.5\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:ip&#34;</span>:<span class="o">{}}}</span>,<span class="s2">&#34;f:startTime&#34;</span>:<span class="o">{}}}}]}}}</span>,<span class="o">{</span><span class="s2">&#34;cells&#34;</span>:<span class="o">[</span><span class="s2">&#34;nginx-f89759699-xcw4j&#34;</span>,<span class="s2">&#34;1/1&#34;</span>,<span class="s2">&#34;Running&#34;</span>,0,<span class="s2">&#34;2d23h&#34;</span>,<span class="s2">&#34;10.200.0.6&#34;</span>,<span class="s2">&#34;k8s4&#34;</span>,<span class="s2">&#34;\u003cnone\u003e&#34;</span>,<span class="s2">&#34;\u003cnone\u003e&#34;</span><span class="o">]</span>,<span class="s2">&#34;object&#34;</span>:<span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;PartialObjectMetadata&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;meta.k8s.io/v1&#34;</span>,<span class="s2">&#34;metadata&#34;</span>:<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;nginx-f89759699-xcw4j&#34;</span>,<span class="s2">&#34;generateName&#34;</span>:<span class="s2">&#34;nginx-f89759699-&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;default&#34;</span>,<span class="s2">&#34;selfLink&#34;</span>:<span class="s2">&#34;/api/v1/namespaces/default/pods/nginx-f89759699-xcw4j&#34;</span>,<span class="s2">&#34;uid&#34;</span>:<span class="s2">&#34;662d1afd-4419-4224-b445-db28274a8029&#34;</span>,<span class="s2">&#34;resourceVersion&#34;</span>:<span class="s2">&#34;263856&#34;</span>,<span class="s2">&#34;creationTimestamp&#34;</span>:<span class="s2">&#34;2020-08-21T03:01:17Z&#34;</span>,<span class="s2">&#34;labels&#34;</span>:<span class="o">{</span><span class="s2">&#34;app&#34;</span>:<span class="s2">&#34;nginx&#34;</span>,<span class="s2">&#34;pod-template-hash&#34;</span>:<span class="s2">&#34;f89759699&#34;</span><span class="o">}</span>,<span class="s2">&#34;ownerReferences&#34;</span>:<span class="o">[{</span><span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;apps/v1&#34;</span>,<span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;ReplicaSet&#34;</span>,<span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;nginx-f89759699&#34;</span>,<span class="s2">&#34;uid&#34;</span>:<span class="s2">&#34;a1760f8b-21a4-4681-aa86-705d52e28a7f&#34;</span>,<span class="s2">&#34;controller&#34;</span>:true,<span class="s2">&#34;blockOwnerDeletion&#34;</span>:true<span class="o">}]</span>,<span class="s2">&#34;managedFields&#34;</span>:<span class="o">[{</span><span class="s2">&#34;manager&#34;</span>:<span class="s2">&#34;kube-controller-manager&#34;</span>,<span class="s2">&#34;operation&#34;</span>:<span class="s2">&#34;Update&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;v1&#34;</span>,<span class="s2">&#34;time&#34;</span>:<span class="s2">&#34;2020-08-21T13:02:20Z&#34;</span>,<span class="s2">&#34;fieldsType&#34;</span>:<span class="s2">&#34;FieldsV1&#34;</span>,<span class="s2">&#34;fieldsV1&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:metadata&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:generateName&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:labels&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:app&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:pod-template-hash&#34;</span>:<span class="o">{}}</span>,<span class="s2">&#34;f:ownerReferences&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;k:{\&#34;uid\&#34;:\&#34;a1760f8b-21a4-4681-aa86-705d52e28a7f\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:apiVersion&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:blockOwnerDeletion&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:controller&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:kind&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:name&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:uid&#34;</span>:<span class="o">{}}}}</span>,<span class="s2">&#34;f:spec&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:containers&#34;</span>:<span class="o">{</span><span class="s2">&#34;k:{\&#34;name\&#34;:\&#34;nginx\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:image&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:imagePullPolicy&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:name&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:resources&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:terminationMessagePath&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:terminationMessagePolicy&#34;</span>:<span class="o">{}}}</span>,<span class="s2">&#34;f:dnsPolicy&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:enableServiceLinks&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:restartPolicy&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:schedulerName&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:securityContext&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:terminationGracePeriodSeconds&#34;</span>:<span class="o">{}}}}</span>,<span class="o">{</span><span class="s2">&#34;manager&#34;</span>:<span class="s2">&#34;kubelet&#34;</span>,<span class="s2">&#34;operation&#34;</span>:<span class="s2">&#34;Update&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;v1&#34;</span>,<span class="s2">&#34;time&#34;</span>:<span class="s2">&#34;2020-08-21T13:04:18Z&#34;</span>,<span class="s2">&#34;fieldsType&#34;</span>:<span class="s2">&#34;FieldsV1&#34;</span>,<span class="s2">&#34;fieldsV1&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:status&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:conditions&#34;</span>:<span class="o">{</span><span class="s2">&#34;k:{\&#34;type\&#34;:\&#34;ContainersReady\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastProbeTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastTransitionTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:status&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:type&#34;</span>:<span class="o">{}}</span>,<span class="s2">&#34;k:{\&#34;type\&#34;:\&#34;Initialized\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastProbeTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastTransitionTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:status&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:type&#34;</span>:<span class="o">{}}</span>,<span class="s2">&#34;k:{\&#34;type\&#34;:\&#34;Ready\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastProbeTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:lastTransitionTime&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:status&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:type&#34;</span>:<span class="o">{}}}</span>,<span class="s2">&#34;f:containerStatuses&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:hostIP&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:phase&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:podIP&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:podIPs&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;k:{\&#34;ip\&#34;:\&#34;10.200.0.6\&#34;}&#34;</span>:<span class="o">{</span><span class="s2">&#34;.&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;f:ip&#34;</span>:<span class="o">{}}}</span>,<span class="s2">&#34;f:startTime&#34;</span>:<span class="o">{}}}}]}}}]}</span>
</code></pre></div><p>However, according to <a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#alternate-representations-of-resources"target="_blank">the API reference</a>, we can also get the resource in Protobuf format by setting <code>Accept</code> request header to <code>application/vnd.kubernetes.protobuf</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">curl -k -XGET -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span><span class="s2">&#34;</span> -H <span class="s2">&#34;Accept: application/vnd.kubernetes.protobuf&#34;</span> <span class="s1">&#39;https://10.61.2.249:6443/api/v1/persistentvolumes/pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89&#39;</span> --output -
k8s

v1PersistentVolumeï¿½
ï¿½
<span class="o">(</span>pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89<span class="s2">&#34;B/api/v1/persistentvolumes/pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89*</span><span class="nv">$d77ec8f7</span><span class="s2">-710f-4005-b119-b7c1cda8d7e72  112535964ï¿½ï¿½ï¿½ï¿½PZ
</span><span class="s2">
</span><span class="s2">appimageb1
</span><span class="s2">pv.kubernetes.io/provisioned-bystorage.io/nfsr
</span><span class="s2">
</span><span class="s2">storage
</span><span class="s2">1GiS*Q
</span><span class="s2">
</span><span class="s2">ReadWriteOnce&#34;</span><span class="se">\a</span>ta/nfs1/image-repo-pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89
PersistentVolumeClaimimagerepo<span class="s2">&#34;</span><span class="nv">$eef4ec4b</span><span class="s2">-326d-47e6-b11c-6474a5fd4d89*v12  111102610:*Delete2managed-nfs-storageB
</span><span class="s2">Filesystem
</span><span class="s2">
</span><span class="s2">Bound&#34;</span>%
</code></pre></div><p>Looks familiar? It confirmed that the value stored in etcd is in Protobuf format, and the <code>k8s</code> characters at the beginning of the value are the kubernetes Protobuf magic number prefix which according to the <a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#protobuf-encoding"target="_blank">API doc</a> helps identify content in disk or etcd as Protobuf. The schema for the above binary value is:</p>
<div class="highlight"><pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="n">A</span> <span class="n">four</span> <span class="n">byte</span> <span class="n">magic</span> <span class="n">number</span> <span class="n">prefix</span><span class="o">:</span><span class="err">
</span><span class="err"></span>  <span class="n">Bytes</span> <span class="mi">0</span><span class="o">-</span><span class="mi">3</span><span class="o">:</span> <span class="s">&#34;k8s\x00&#34;</span> <span class="p">[</span><span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">]</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="n">An</span> <span class="n">encoded</span> <span class="n">Protobuf</span> <span class="kd">message</span> <span class="nc">with</span> <span class="n">the</span> <span class="n">following</span> <span class="n">IDL</span><span class="o">:</span><span class="err">
</span><span class="err"></span>  <span class="kd">message</span> <span class="nc">Unknown</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="c1">// typeMeta should have the string values for &#34;kind&#34; and &#34;apiVersion&#34; as set on the JSON object
</span><span class="c1"></span>    <span class="k">optional</span> <span class="n">TypeMeta</span> <span class="n">typeMeta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span>    <span class="c1">// raw will hold the complete serialized object in protobuf. See the protobuf definitions in the client libraries for a given kind.
</span><span class="c1"></span>    <span class="k">optional</span> <span class="kt">bytes</span> <span class="n">raw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span>    <span class="c1">// contentEncoding is encoding used for the raw data. Unspecified means no encoding.
</span><span class="c1"></span>    <span class="k">optional</span> <span class="kt">string</span> <span class="n">contentEncoding</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span>    <span class="c1">// contentType is the serialization method used to serialize &#39;raw&#39;. Unspecified means application/vnd.kubernetes.protobuf and is usually
</span><span class="c1"></span>    <span class="c1">// omitted.
</span><span class="c1"></span>    <span class="k">optional</span> <span class="kt">string</span> <span class="n">contentType</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="kd">message</span> <span class="nc">TypeMeta</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="c1">// apiVersion is the group/version for this type
</span><span class="c1"></span>    <span class="k">optional</span> <span class="kt">string</span> <span class="n">apiVersion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="c1">// kind is the name of the object schema. A protobuf definition should exist for this object.
</span><span class="c1"></span>    <span class="k">optional</span> <span class="kt">string</span> <span class="n">kind</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err"></span><span class="o">...</span> <span class="o">...</span>  <span class="err">
</span></code></pre></div><p>Protobuf provides better performance at scale, kubernetes uses this format to store the value in etcd, however, this is bad news for me because I want to update the value directly. If it is in JSON format I could just get the string value and remove <code>deletionTimestamp</code> and <code>deletionGracePeriodSeconds</code> key-value in the string then save it back. But now I cannot simply manipulate the return value as it is in Protobuf(binary) format. Maybe I can? The <code>deletionTimestamp</code> is a <code>time.Time</code> type and <code>deletionGracePeriodSeconds</code> is <code>int64</code>, it probably mapping to a few &lsquo;ï¿½&rsquo; in the binary value, I can refer to <a href="https://developers.google.com/protocol-buffers/docs/encoding"target="_blank">Protobuf encoding</a> to know exactly where they are and changes the bytes to remove them. I do not want to go that path as it is risky and costly, because if I do anything careless again, it will make the situation even worse. For example(yes, I triedðŸ¤ª), like:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get pv
Error from server <span class="o">(</span>NotAcceptable<span class="o">)</span>: object *core.PersistentVolume does not implement the protobuf marshalling interface and cannot be encoded to a protobuf message
</code></pre></div><p>A better way is to decode(unmarshal) the binary value into Go data type, change the required values, encode the updated value, then save it back to etcd.</p>
<h2 id="the-journey-of-serializer">The journey of serializer</h2>
<p>As I mentioned earlier, kubernetes do not simply uses Protobuf to encode its data type, it creates a customized wrapper to encode/decode Go data type to and from Protobuf, remember the four-byte magic number? I think I can reuse this wrapper to do my work. It should be related to the code that interacts with etcd, and the API server is the only kubernetes component that connects to etcd, I start searching clues in the <a href="https://github.com/kubernetes/apiserver"target="_blank">API server code</a>. The <a href="https://github.com/kubernetes/apiserver/blob/release-1.19/pkg/storage/etcd3/store.go#L66-L75"target="_blank">store.go</a> looks promising, especially the <code>runtime.Codec</code> field inside <code>type store struct</code>. I guess it may be used for data encoding/decoding, so let&rsquo;s dig deeper. The <a href="https://github.com/kubernetes/apimachinery/blob/release-1.19/pkg/runtime/interfaces.go#L51-L94"target="_blank">Codec</a> turn out to be a Serializer interface composed by Encoder and Decoder interfaces, bingo. Now what I need is to find out a Protobuf Serializer implementation, Let&rsquo;s keep digging. When I look at the <a href="https://github.com/kubernetes/apimachinery/tree/release-1.19/pkg/runtime/serializer"target="_blank">directory structure</a> I see folders named <code>json</code> and <code>protobuf</code> and a file named <code>codec_factory.go</code>, the json folder contains the JSON implementation of the Serializer interface, and the protobuf folder contains the Protobuf implementation that I was looking for. Even better, the <a href="https://github.com/kubernetes/apimachinery/blob/release-1.19/pkg/runtime/serializer/codec_factory.go#L77"target="_blank">codec_factory.go</a> has the code about how to initialize the Protobuf Serializer. Now everything is sorted out, I just need to write the code to complete the work, the logic is like:</p>
<div class="mermaid">
    
%%{init: {'theme': 'dark'}}%%
graph TD;
  1[Get PV value from etcd which in protobuf format] ==> 2[Decode protobuf value to PV struct];
  2 ==> 3[Set PV status from Terminating to Bound by removing value of DeletionTimestamp and DeletionGracePeriodSeconds];
  3 ==> 4[Encode fixed PV struct to protobuf value];
  4 ==> 5[Write the updated protobuf value back to etcd];

</div>
  
<p>The corresponding code is straightforward:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">recoverPV</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

  <span class="nx">gvk</span> <span class="o">:=</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">GroupName</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">,</span> <span class="nx">Kind</span><span class="p">:</span> <span class="s">&#34;PersistentVolume&#34;</span><span class="p">}</span>
  <span class="nx">pv</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PersistentVolume</span><span class="p">{}</span>

  <span class="nx">runtimeScheme</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewScheme</span><span class="p">()</span>
  <span class="nx">runtimeScheme</span><span class="p">.</span><span class="nf">AddKnownTypeWithName</span><span class="p">(</span><span class="nx">gvk</span><span class="p">,</span> <span class="nx">pv</span><span class="p">)</span>
  <span class="nx">protoSerializer</span> <span class="o">:=</span> <span class="nx">protobuf</span><span class="p">.</span><span class="nf">NewSerializer</span><span class="p">(</span><span class="nx">runtimeScheme</span><span class="p">,</span> <span class="nx">runtimeScheme</span><span class="p">)</span>
  <span class="nx">key</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;/%s/persistentvolumes/%s&#34;</span><span class="p">,</span> <span class="nx">k8sKeyPrefix</span><span class="p">,</span> <span class="nx">pvName</span><span class="p">)</span>

  <span class="c1">// Get value from etcd
</span><span class="c1"></span>  <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Kvs</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot find persistent volume [%s] in etcd with key [%s]\nplease check the k8s-key-prefix and the persistent volume name are set correctly&#34;</span><span class="p">,</span> <span class="nx">pvName</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// Decode protobuf value to Go pv struct
</span><span class="c1"></span>  <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">protoSerializer</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Kvs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Value</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">gvk</span><span class="p">,</span> <span class="nx">pv</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="nx">pv</span><span class="p">).</span><span class="nx">ObjectMeta</span><span class="p">.</span><span class="nx">DeletionTimestamp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;persistent volume [%s] is not in terminating status&#34;</span><span class="p">,</span> <span class="nx">pvName</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// Set PV status from terminating back to bound
</span><span class="c1"></span>  <span class="p">(</span><span class="o">*</span><span class="nx">pv</span><span class="p">).</span><span class="nx">ObjectMeta</span><span class="p">.</span><span class="nx">DeletionTimestamp</span> <span class="p">=</span> <span class="kc">nil</span>
  <span class="p">(</span><span class="o">*</span><span class="nx">pv</span><span class="p">).</span><span class="nx">ObjectMeta</span><span class="p">.</span><span class="nx">DeletionGracePeriodSeconds</span> <span class="p">=</span> <span class="kc">nil</span>

  <span class="kd">var</span> <span class="nx">fixedPV</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
  <span class="c1">// Encode fixed PV to protobuf value
</span><span class="c1"></span>  <span class="nx">err</span> <span class="p">=</span> <span class="nx">protoSerializer</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">pv</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">fixedPV</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="c1">// Write the updated value back to etcd
</span><span class="c1"></span>  <span class="nx">client</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">fixedPV</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>One thing worth mention is the etcd key format, the community version of kubernetes uses <code>/registry</code> as etcd key prefix, so the key for persistent volume pv1 is <code>/registry/persistentvolumes/pv1</code>. OpenShift uses <code>/kubernetes.io</code> as prefix and the key for pv1 is <code>/kubernetes.io/persistentvolumes/pv1</code>. My environment is an OpenShift cluster.</p>
<h2 id="the-end">The end</h2>
<p>After run <code>recoverPV()</code>, the terminating persistent volume is back to bound status. Finally.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">./resetpv --k8s-key-prefix kubernetes.io pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89

kubectl get pv

NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM         STORAGECLASS          REASON   AGE
pvc-eef4ec4b-326d-47e6-b11c-6474a5fd4d89   1Gi        RWO            Delete           Bound    image/repo    managed-nfs-storage            2d11h
</code></pre></div><p>Although I made a mistake, I did learn a lot by trying to fix it. The lessons learned are always double confirm and know how to restore the change before you update or delete anything on the important system. <del>Unless you&rsquo;re absolutely sure what you are doing.</del></p>
<p>The source code and how to use it can be found <a href="https://github.com/jianz/k8s-reset-terminating-pv"target="_blank">here</a>.</p>
<p>Cheers.ðŸ»</p>
</article><section class="article labels"><a class="category" href=/categories/kubernetes/>kubernetes</a><a class="tag" href=/tags/etcd/>etcd</a><a class="tag" href=/tags/go/>go</a><a class="tag" href=/tags/k8s/>k8s</a><a class="tag" href=/tags/pv/>pv</a><a class="tag" href=/tags/protobuf/>protobuf</a></section></div>
<div class="article bottom"><section class="article discussion"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jianz-gitpage" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">Â©2020 Jian Zhang under CC BY-SA 4.0</p>
    <p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank">Notepadium</a></p></div></section>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-131351449-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script src="/js/core.min.4633cf9b472d3441451e45bc65e3e727eb7c57e56128c5b43a14131a3359dc43348e58347361a41a186fbd3c2bc09037.js" integrity="sha384-RjPPm0ctNEFFHkW8ZePnJ&#43;t8V&#43;VhKMW0OhQTGjNZ3EM0jlg0c2GkGhhvvTwrwJA3"></script></body>

</html>